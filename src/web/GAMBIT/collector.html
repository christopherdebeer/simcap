<!DOCTYPE html>
<html>
<head>
    <title>SIMCAP | GAMBIT Collector v2</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <!-- Eruda Dev Console for Mobile Debugging -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <!-- Dependencies -->
    <script src="puck.js"></script>
    <script src="gambit-client.js"></script>
    <script src="calibration.js"></script>
    <script src="hand-model.js"></script>
    <script src="filters.js"></script>
    <!-- Styles -->
    <link rel="stylesheet" href="../../simcap.css">
    <link rel="stylesheet" href="collector.css">
</head>
<body>
    <header class="page-title">
        <h1>- SIMCAP -<span class="grad">GAMBIT Collector</span></h1>
        <p class="subtitle">Multi-Label Data Collection for Magnetic Finger Tracking</p>
    </header>

    <!-- Connection -->
    <section>
        <h2>Connection</h2>
        <div class="row">
            <button id="connectBtn" class="btn-primary">Connect Device</button>
            <div id="statusIndicator" class="status disconnected">Disconnected</div>
        </div>
    </section>

    <!-- Calibration Wizard -->
    <section>
        <h2 class="collapsible">Calibration Wizard</h2>
        <div class="collapse-content">
            <p style="font-size: 11px; color: var(--fg-muted); margin-bottom: 12px;">
                Calibrate the magnetometer to remove environmental interference. Required for accurate magnetic finger tracking.
            </p>

            <div id="calibrationStatus" style="background: var(--bg); padding: 8px; border-radius: 4px; margin-bottom: 12px;">
                <div style="font-size: 11px; font-weight: 500; margin-bottom: 4px;">Status: <span id="calStatusText">Not Calibrated</span></div>
                <div style="font-size: 10px; color: var(--fg-muted);" id="calDetails">No calibration loaded</div>
            </div>

            <!-- Step 1: Earth Field -->
            <div id="calStep1" class="calibration-step">
                <h3>Step 1: Earth Field Calibration</h3>
                <p style="font-size: 11px; margin-bottom: 8px;">Hold device still, away from magnets (>50cm)</p>
                <div class="row">
                    <button id="startEarthCal" class="btn-secondary" disabled>Start (5 seconds)</button>
                    <div id="earthProgress" style="flex: 1;"></div>
                </div>
                <div id="earthQuality" style="font-size: 10px; margin-top: 4px;"></div>
            </div>

            <!-- Step 2: Hard Iron -->
            <div id="calStep2" class="calibration-step">
                <h3>Step 2: Hard Iron Calibration</h3>
                <p style="font-size: 11px; margin-bottom: 8px;">Rotate device in figure-8 pattern covering all orientations</p>
                <div class="row">
                    <button id="startHardIronCal" class="btn-secondary" disabled>Start (10 seconds)</button>
                    <div id="hardIronProgress" style="flex: 1;"></div>
                </div>
                <div id="hardIronQuality" style="font-size: 10px; margin-top: 4px;"></div>
            </div>

            <!-- Step 3: Soft Iron -->
            <div id="calStep3" class="calibration-step">
                <h3>Step 3: Soft Iron Calibration</h3>
                <p style="font-size: 11px; margin-bottom: 8px;">Continue rotating to capture field distortion</p>
                <div class="row">
                    <button id="startSoftIronCal" class="btn-secondary" disabled>Start (10 seconds)</button>
                    <div id="softIronProgress" style="flex: 1;"></div>
                </div>
                <div id="softIronQuality" style="font-size: 10px; margin-top: 4px;"></div>
            </div>

            <div class="row" style="margin-top: 12px;">
                <button id="loadCalibration" class="btn-secondary">Load from File</button>
                <button id="saveCalibration" class="btn-secondary" disabled>Save to File</button>
                <button id="resetCalibration" class="btn-danger" style="margin-left: auto;">Reset</button>
            </div>
        </div>
    </section>

    <!-- Session Metadata -->
    <section>
        <h2 class="collapsible">Session Metadata</h2>
        <div class="collapse-content">
            <div class="row">
                <div>
                    <label>Subject ID</label>
                    <input type="text" id="subjectId" value="user_001" />
                </div>
                <div>
                    <label>Environment</label>
                    <select id="environment">
                        <option value="home">Home</option>
                        <option value="office">Office</option>
                        <option value="outdoor">Outdoor</option>
                        <option value="lab">Lab</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div>
                    <label>Hand</label>
                    <select id="hand">
                        <option value="right">Right</option>
                        <option value="left">Left</option>
                        <option value="unknown">Unknown</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div>
                    <label>Data Split</label>
                    <select id="split">
                        <option value="train">Train (80%)</option>
                        <option value="validation">Validation (10%)</option>
                        <option value="test">Test (10%)</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div>
                    <label>Magnet Configuration</label>
                    <select id="magnetConfig">
                        <option value="none">No Magnets</option>
                        <option value="single_index">Single - Index</option>
                        <option value="single_thumb">Single - Thumb</option>
                        <option value="alternating">All Fingers (Alternating)</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div>
                    <label>Magnet Type</label>
                    <select id="magnetType">
                        <option value="6x3mm_N48">6x3mm N48</option>
                        <option value="5x2mm_N42">5x2mm N42</option>
                        <option value="3x1mm_N35">3x1mm N35</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div style="flex: 2">
                    <label>Session Notes</label>
                    <input type="text" id="sessionNotes" placeholder="Optional notes about this session..." />
                </div>
            </div>
        </div>
    </section>

    <!-- Multi-Label Selection -->
    <section>
        <h2 class="collapsible">Active Labels (Multi-Select)</h2>

        <!-- Current active labels display - always visible -->
        <div class="active-labels">
            <label>Currently Active:</label>
            <div class="active-labels-list" id="activeLabelsDisplay">
                <span style="color: var(--fg-muted);">No labels selected</span>
            </div>
        </div>

        <!-- Collapsible content - label selection buttons -->
        <div class="collapse-content">
        <!-- Hand Pose -->
        <div class="label-category">
            <h4>Hand Pose</h4>
            <div class="label-grid" id="poseButtons">
                <button class="btn-secondary label-btn" data-pose="rest">REST</button>
                <button class="btn-secondary label-btn" data-pose="fist">FIST</button>
                <button class="btn-secondary label-btn" data-pose="open_palm">OPEN</button>
                <button class="btn-secondary label-btn" data-pose="index_up">POINT</button>
                <button class="btn-secondary label-btn" data-pose="peace">PEACE</button>
                <button class="btn-secondary label-btn" data-pose="thumbs_up">THUMBS</button>
                <button class="btn-secondary label-btn" data-pose="ok_sign">OK</button>
                <button class="btn-secondary label-btn" data-pose="pinch">PINCH</button>
                <button class="btn-secondary label-btn" data-pose="grab">GRAB</button>
                <button class="btn-secondary label-btn" data-pose="wave">WAVE</button>
            </div>
        </div>

        <!-- Finger States -->
        <div class="label-category">
            <h4>Finger States (Per-Finger)</h4>
            <div class="finger-grid">
                <div class="finger-col">
                    <label>Thumb</label>
                    <button class="btn-secondary finger-state-btn extended" data-finger="thumb" data-state="extended">EXT</button>
                    <button class="btn-secondary finger-state-btn partial" data-finger="thumb" data-state="partial">PART</button>
                    <button class="btn-secondary finger-state-btn flexed" data-finger="thumb" data-state="flexed">FLEX</button>
                </div>
                <div class="finger-col">
                    <label>Index</label>
                    <button class="btn-secondary finger-state-btn extended" data-finger="index" data-state="extended">EXT</button>
                    <button class="btn-secondary finger-state-btn partial" data-finger="index" data-state="partial">PART</button>
                    <button class="btn-secondary finger-state-btn flexed" data-finger="index" data-state="flexed">FLEX</button>
                </div>
                <div class="finger-col">
                    <label>Middle</label>
                    <button class="btn-secondary finger-state-btn extended" data-finger="middle" data-state="extended">EXT</button>
                    <button class="btn-secondary finger-state-btn partial" data-finger="middle" data-state="partial">PART</button>
                    <button class="btn-secondary finger-state-btn flexed" data-finger="middle" data-state="flexed">FLEX</button>
                </div>
                <div class="finger-col">
                    <label>Ring</label>
                    <button class="btn-secondary finger-state-btn extended" data-finger="ring" data-state="extended">EXT</button>
                    <button class="btn-secondary finger-state-btn partial" data-finger="ring" data-state="partial">PART</button>
                    <button class="btn-secondary finger-state-btn flexed" data-finger="ring" data-state="flexed">FLEX</button>
                </div>
                <div class="finger-col">
                    <label>Pinky</label>
                    <button class="btn-secondary finger-state-btn extended" data-finger="pinky" data-state="extended">EXT</button>
                    <button class="btn-secondary finger-state-btn partial" data-finger="pinky" data-state="partial">PART</button>
                    <button class="btn-secondary finger-state-btn flexed" data-finger="pinky" data-state="flexed">FLEX</button>
                </div>
            </div>
        </div>

        <!-- Motion State -->
        <div class="label-category">
            <h4>Motion State</h4>
            <div class="label-grid">
                <button class="btn-secondary label-btn active" data-motion="static">STATIC</button>
                <button class="btn-secondary label-btn" data-motion="moving">MOVING</button>
                <button class="btn-secondary label-btn" data-motion="transition">TRANSITION</button>
            </div>
        </div>

        <!-- Calibration -->
        <div class="label-category">
            <h4>Calibration Markers</h4>
            <div class="label-grid">
                <button class="btn-secondary label-btn calibration" data-calibration="earth_field">EARTH FIELD</button>
                <button class="btn-secondary label-btn calibration" data-calibration="hard_iron">HARD IRON</button>
                <button class="btn-secondary label-btn calibration" data-calibration="soft_iron">SOFT IRON</button>
                <button class="btn-secondary label-btn calibration" data-calibration="finger_range">FINGER RANGE</button>
                <button class="btn-secondary label-btn calibration" data-calibration="reference_pose">REF POSE</button>
                <button class="btn-secondary label-btn calibration" data-calibration="magnet_baseline">MAG BASELINE</button>
            </div>
        </div>

        <!-- Custom Labels -->
        <div class="label-category">
            <h4>Custom Labels</h4>
            <div class="custom-input-row">
                <input type="text" id="customLabelInput" placeholder="Add custom label..." />
                <button class="btn-primary btn-small" onclick="addCustomLabel()">Add</button>
            </div>
            <div class="custom-labels-list" id="customLabelsList"></div>
            <div style="margin-top: 8px;">
                <label>Quick Add Presets:</label>
                <div class="label-grid" style="margin-top: 4px;">
                    <button class="btn-secondary btn-tiny" onclick="addPresetLabels('phase1')">Phase 1</button>
                    <button class="btn-secondary btn-tiny" onclick="addPresetLabels('phase2')">Phase 2</button>
                    <button class="btn-secondary btn-tiny" onclick="addPresetLabels('quality')">Quality</button>
                    <button class="btn-secondary btn-tiny" onclick="addPresetLabels('transitions')">Transitions</button>
                </div>
            </div>
        </div>
        </div>
    </section>

    <!-- Recording Controls -->
    <section>
        <h2>Recording</h2>
        <div class="sample-counter">
            <span id="sampleCount">0</span> samples
        </div>
        <div class="progress-bar">
            <div class="fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="row" style="margin-top: 10px">
            <button id="startBtn" class="btn-success" disabled>Start Recording</button>
            <button id="stopBtn" class="btn-danger" disabled>Stop Recording</button>
        </div>
        <div class="row">
            <button id="clearBtn" class="btn-secondary" disabled>Clear Session</button>
            <button id="exportBtn" class="btn-primary" disabled>Export Data</button>
        </div>
        <div class="row">
            <button id="uploadBtn" class="btn-success" disabled>Upload to GitHub</button>
        </div>
        <div class="row">
            <button id="wizardBtn" class="btn-warning" disabled>üìã Data Collection Wizard</button>
        </div>
        <div class="row">
            <button id="poseEstimationBtn" class="btn-secondary" disabled>üéØ Enable Pose Tracking</button>
        </div>
        <div id="poseEstimationStatus" style="display: none; margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border);">
            <div style="font-size: 12px; color: var(--fg-muted); margin-bottom: 5px;">Pose Estimation</div>
            <div style="font-size: 14px; color: var(--accent);">
                Status: <span id="poseStatusText">Disabled</span>
            </div>
            <div style="font-size: 14px; color: var(--accent); margin-top: 5px;">
                Confidence: <span id="poseConfidenceText">0%</span>
            </div>
            <div style="font-size: 11px; color: var(--fg-muted); margin-top: 5px;">
                Updates: <span id="poseUpdatesText">0</span>
            </div>
        </div>
    </section>

    <!-- GitHub Sync -->
    <section>
        <h2 class="collapsible collapsed">GitHub Sync</h2>
        <div class="collapse-content hidden">
            <div class="row">
                <div style="flex: 2">
                    <label>GitHub Token (PAT with repo scope)</label>
                    <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx" />
                </div>
            </div>
            <div style="font-size: 11px; color: var(--fg-muted); margin-top: 5px;">
                Token is stored locally. Data uploads to: data/GAMBIT/labeled/
            </div>
        </div>
    </section>

    <!-- Labels Created -->
    <section>
        <h2>Labels (<span id="labelCount">0</span>)</h2>
        <div class="labels-list" id="labelsList">
            <div style="color: var(--fg-muted); text-align: center; padding: 10px;">
                No labels yet. Start recording and change labels to create segments.
            </div>
        </div>
    </section>

    <!-- Hand State Visualization -->
    <section>
        <h2 class="collapsible">Hand State Preview</h2>
        <div class="collapse-content">
            <!-- Mode Toggle -->
            <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 10px;">
                <button id="handModeLabels" class="btn-primary btn-small" onclick="setHandPreviewMode('labels')">üè∑Ô∏è Labels</button>
                <button id="handModePredictions" class="btn-secondary btn-small" onclick="setHandPreviewMode('predictions')">üéØ Predictions</button>
            </div>
            <!-- Mode Indicator -->
            <div id="handModeIndicator" style="text-align: center; padding: 6px; margin-bottom: 10px; border-radius: 4px; font-size: 11px; font-weight: 500; background: var(--accent); color: var(--bg);">
                üìã Showing: Manual Labels
            </div>
            <div style="display: flex; justify-content: center; padding: 10px;">
                <canvas id="handCanvas" width="400" height="400" style="border: 1px solid var(--border); background: var(--bg); border-radius: 8px;"></canvas>
            </div>
            <div id="handPreviewDescription" style="text-align: center; color: var(--fg-muted); font-size: 12px; margin-top: 10px;">
                Visual representation of manually selected finger states
            </div>
            <!-- Prediction confidence (only shown in predictions mode) -->
            <div id="handPredictionInfo" style="display: none; text-align: center; margin-top: 10px; padding: 8px; background: var(--bg); border-radius: 4px;">
                <div style="font-size: 11px; color: var(--fg-muted);">Prediction Confidence</div>
                <div id="handPredictionConfidence" style="font-size: 16px; font-weight: bold; color: var(--accent);">--</div>
            </div>
        </div>
    </section>

    <!-- Live Data View -->
    <section>
        <h2 class="collapsible">Live Sensor Data</h2>
        <div class="collapse-content">
            <div class="data-view">
                <div class="row">
                    <span class="label">Acc:</span>
                    <div class="values">
                        <span class="value" id="ax">-</span>
                        <span class="value" id="ay">-</span>
                        <span class="value" id="az">-</span>
                    </div>
                </div>
                <div class="row">
                    <span class="label">Gyro:</span>
                    <div class="values">
                        <span class="value" id="gx">-</span>
                        <span class="value" id="gy">-</span>
                        <span class="value" id="gz">-</span>
                    </div>
                </div>
                <div class="row">
                    <span class="label">Mag:</span>
                    <div class="values">
                        <span class="value" id="mx">-</span>
                        <span class="value" id="my">-</span>
                        <span class="value" id="mz">-</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Log -->
    <section>
        <h2 class="collapsible collapsed">Log</h2>
        <div class="collapse-content hidden" id="logSection">
            <div id="log"></div>
        </div>
    </section>

    <!-- Data Collection Wizard Modal -->
    <div class="wizard-overlay" id="wizardOverlay">
        <div class="wizard-modal">
            <button class="wizard-close" onclick="closeWizard()">&times;</button>
            <div class="wizard-header">
                <h2 id="wizardTitle">Calibration Wizard</h2>
                <div class="phase-label" id="wizardPhase">Select calibration mode</div>
            </div>
            <div class="wizard-progress">
                <div class="wizard-progress-bar">
                    <div class="fill" id="wizardProgressFill" style="width: 0%"></div>
                </div>
                <div class="wizard-progress-text">
                    <span id="wizardStepText">Step 0 of 0</span>
                    <span id="wizardTimeText">~0s remaining</span>
                </div>
            </div>
            <div class="wizard-content" id="wizardContent">
                <!-- Dynamic content inserted here -->
            </div>
            <div class="wizard-stats" id="wizardStats">
                <span>üìä <span id="wizardSamples">0</span> samples</span>
                <span>üè∑Ô∏è <span id="wizardLabels">0</span> labels</span>
            </div>
        </div>
    </div>

    <!-- Application Script -->
    <script src="collector.js"></script>
</body>
</html>
